name: Enterprise Release Pipeline

on:
  push:
    tags:
      - 'v*' # Triggers only when you push a tag like v1.0.0

permissions:
  contents: write      # To upload release assets
  id-token: write      # REQUIRED for SLSA attestations
  attestations: write  # REQUIRED for SLSA attestations

jobs:
  build-sign-publish:
    name: Build, Sign & Release
    runs-on: ubuntu-22.04
    env:
      ARCH: amd64
      TARGET: x86_64-unknown-linux-gnu

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Build Tools (Deb & SBOM)
        run: |
          sudo apt-get update && sudo apt-get install -y dpkg-sig
          cargo install cargo-deb
          cargo install cargo-cyclonedx

      - name: Import GPG Key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build Signed Debian Package
        run: |
          # Build the .deb
          cargo deb --target ${{ env.TARGET }} --output target/ufw-rule-parser_${{ env.ARCH }}.deb
          ls -lh target/ufw-rule-parser_${{ env.ARCH }}.deb
          # Sign the .deb internals (Embedded Signature)
          dpkg-sig --sign builder \
            -k "${{ steps.import_gpg.outputs.keyid }}" \
            "target/ufw-rule-parser_${{ env.ARCH }}.deb"        
          # Verify immediately
          dpkg-sig --verify "target/ufw-rule-parser_${{ env.ARCH }}.deb"

      - name: Generate & Sign SBOM
        run: |
          # Generate SBOM (CycloneDX JSON)
          cargo cyclonedx --all --format json --output-format json --output-file target/sbom.json
          
          # Sign the SBOM (Detached Signature)
          gpg --batch --yes --passphrase ${{ secrets.GPG_PASSPHRASE }} --pinentry-mode loopback --detach-sign --armor --output target/sbom.json.asc target/sbom.json

      - name: Generate & Sign Checksums
        run: |
          cd target
          sha256sum ufw-rule-parser_${{ env.ARCH }}.deb sbom.json > SHA256SUMS
          
          # Sign the Checksums file
          gpg --batch --yes --passphrase ${{ secrets.GPG_PASSPHRASE }} --pinentry-mode loopback --detach-sign --armor --output SHA256SUMS.asc SHA256SUMS

      - name: Generate Artifact Attestations
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            target/ufw-rule-parser_${{ env.ARCH }}.deb
            target/sbom.json

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/ufw-rule-parser_${{ env.ARCH }}.deb
            target/sbom.json
            target/sbom.json.asc
            target/SHA256SUMS
            target/SHA256SUMS.asc
